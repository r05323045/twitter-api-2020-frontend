(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-476cacfe"],{"0796":function(e,t,r){"use strict";r("83bc")},2532:function(e,t,r){"use strict";var s=r("23e7"),a=r("5a34"),n=r("1d80"),c=r("ab13");s({target:"String",proto:!0,forced:!c("includes")},{includes:function(e){return!!~String(n(this)).indexOf(a(e),arguments.length>1?arguments[1]:void 0)}})},2909:function(e,t,r){"use strict";r.d(t,"a",(function(){return o}));var s=r("6b75");function a(e){if(Array.isArray(e))return Object(s["a"])(e)}r("a4d3"),r("e01a"),r("d28b"),r("a630"),r("d3b7"),r("3ca3"),r("ddb0");function n(e){if("undefined"!==typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}var c=r("06c5");function i(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function o(e){return a(e)||n(e)||Object(c["a"])(e)||i()}},"293a":function(e,t,r){"use strict";r.r(t);var s=function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("div",{staticClass:"chat-main"},[r("Navbar"),r("div",{staticClass:"chat-container"},[r("Chatroom")],1)],1)},a=[],n=r("5530"),c=r("d178"),i=r("2f62"),o=function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("div",{staticClass:"chat-room"},[r("div",{staticClass:"chat-users"},[r("div",{staticClass:"title"},[e._v(" 上線使用者 ("+e._s(e.onlineUsers?e.onlineUsers.length:0)+") ")]),e.onlineUsers.length>0?r("div",{staticClass:"list-group"},e._l(e.onlineUsers,(function(t){return r("div",{key:""+(t.id+Math.random()),staticClass:"list-group-item"},[r("div",{staticClass:"avatar",style:{background:"url("+(t.User?t.User.avatar:"")+") no-repeat center/cover"},on:{click:function(r){e.$router.push("/user/other/"+t.id).catch((function(){}))}}}),r("div",{staticClass:"info"},[r("div",{staticClass:"name",on:{click:function(r){e.$router.push("/user/other/"+t.id).catch((function(){}))}}},[e._v(e._s(t.User?t.User.name:""))]),r("div",{staticClass:"account",on:{click:function(r){e.$router.push("/user/other/"+t.id).catch((function(){}))}}},[e._v(e._s(t.User?t.User.account:""))])])])})),0):e._e()]),r("MessengeBoard",{on:{someoneComein:e.updateOnelineUsers}})],1)},u=[],l=(r("99af"),r("caad"),r("d81d"),r("b0c0"),r("2532"),r("2909")),d=function(){var e=this,t=e.$createElement,r=e._self._c||t;return e.$refs?r("div",{staticClass:"messenge-board"},[e._m(0),r("div",{ref:"boardWrapper",staticClass:"board-wrapper",on:{click:e.scrollToBottom}},[r("div",{staticClass:"messages"},e._l(e.messages,(function(t,s){return r("div",{key:"msg-"+s},["userComein"===t.type&&e.currentUser.id!==t.UserId?r("div",{staticClass:"broacast-message-wrapper"},[r("div",{staticClass:"broacast-message"},[e._v(e._s(t.message))])]):e._e(),"userComein"!==t.type&&e.currentUser.id!==t.UserId?r("div",{staticClass:"other message"},[r("div",{staticClass:"avatar",style:{background:"url("+(t.User?t.User.avatar:t.avatar)+") no-repeat center/cover"}}),r("div",{staticClass:"wrapper"},[r("div",{staticClass:"text"},[e._v(e._s(t.message))]),r("div",{staticClass:"time"},[e._v(e._s(e._f("fromNow")(t.createdAt)))])])]):e._e(),"userComein"!==t.type&&e.currentUser.id===t.UserId?r("div",{staticClass:"self message"},[r("div",{staticClass:"text"},[e._v(e._s(t.message))]),r("div",{staticClass:"time"},[e._v(e._s(e._f("fromNow")(t.createdAt)))])]):e._e()])})),0)]),r("form",{on:{submit:function(t){return t.preventDefault(),e.sendMessage(t)},click:e.scrollToBottom}},[r("div",{staticClass:"text-wrapper"},[r("input",{directives:[{name:"model",rawName:"v-model",value:e.message,expression:"message"}],staticClass:"text",attrs:{placeholder:"輸入訊息...",onfocus:"this.placeholder = ''",onblur:"this.placeholder = '輸入訊息...'"},domProps:{value:e.message},on:{input:function(t){t.target.composing||(e.message=t.target.value)}}}),r("div",{staticClass:"icon-wrapper",attrs:{type:"submit"},on:{click:e.sendMessage}},[r("div",{staticClass:"icon send"})])])])]):e._e()},f=[function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("div",{staticClass:"top-wrapper"},[r("div",{staticClass:"public-text"},[e._v(" 公開聊天室 ")])])}],m=(r("4de4"),r("4160"),r("b64b"),r("498a"),r("159b"),r("96cf"),r("1da1")),h=r("2fa3"),p=r("2313"),v={data:function(){return{message:"",messages:[],userComeinObject:{}}},created:function(){window.addEventListener("beforeunload",this.leaveChatroom())},mounted:function(){var e=this;this.fetchChatroom(),this.$socket.emit("chatting",Object(n["a"])(Object(n["a"])({},this.currentUser),{},{createdAt:new Date,type:"userComein"})),this.$socket.on("userOnline",(function(t){e.$emit("someoneComein",t);var r=e.$refs.boardWrapper;r&&(r.scrollTop=r.scrollHeight,r.animate({scrollTop:r.scrollHeight}))})),this.$socket.on("msg",(function(t){e.messages=[].concat(Object(l["a"])(e.messages),[{UserId:t.UserId,avatar:t.avatar,message:t.message,createdAt:t.createdAt,type:t.type,User:t.User}]),e.messages.sort((function(e,t){return e.createdAt>t.createdAt?1:-1}));var r=e.$refs.boardWrapper;r&&(r.scrollTop=r.scrollHeight,r.animate({scrollTop:r.scrollHeight}))})),this.$socket.on("newclientlogin",(function(t){e.messages=[].concat(Object(l["a"])(e.messages),[{UserId:t.UserId,avatar:t.avatar,message:t.message,createdAt:t.createdAt,type:t.type,User:t.User}]),e.messages.sort((function(e,t){return e.createdAt>t.createdAt?1:-1})),Object.keys(e.userComeinObject).includes(t.message)||(e.userComeinObject[t.message]=t.createdAt);var r=[];e.messages.forEach((function(t){"userComein"===t.type&&t.createdAt<e.userComeinObject[t.message]&&r.push(t.createdAt)})),e.messages=e.messages.filter((function(e){return!1===r.includes(e.createdAt)}));var s=e.$refs.boardWrapper;s&&(s.scrollTop=s.scrollHeight,s.animate({scrollTop:s.scrollHeight}))}))},beforeDestroy:function(){this.leaveChatroom(),this.$socket.emit("leave",this.currentUser.id)},watch:{messages:function(){if(this.el){var e=this.$refs.boardWrapper;e&&(e.scrollTop=e.scrollHeight,e.animate({scrollTop:e.scrollHeight}))}}},updated:function(){this.scrollToBottom()},computed:Object(n["a"])({},Object(i["b"])(["currentUser","isAuthenticated"])),methods:{scrollToBottom:function(){var e=this.$refs.boardWrapper;e&&(e.scrollTop=e.scrollHeight,e.animate({scrollTop:e.scrollHeight}))},sendMessage:function(e){if(e.preventDefault(),""!==this.message.trim()){this.$socket.emit("send message",{UserId:this.currentUser.id,avatar:this.currentUser.avatar,message:this.message,createdAt:new Date,type:"chat",User:this.currentUser}),this.message="";var t=this.$refs.boardWrapper;t&&(t.scrollTop=t.scrollHeight,t.animate({scrollTop:t.scrollHeight}))}else h["a"].fire({icon:"error",title:"請輸入訊息"})},leaveChatroom:function(){return Object(m["a"])(regeneratorRuntime.mark((function e(){var t,r;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,p["a"].deleteChatRoom();case 3:if(t=e.sent,r=t.data,"success"===r.status){e.next=7;break}throw new Error(r.message);case 7:e.next=12;break;case 9:e.prev=9,e.t0=e["catch"](0),console.log(e.t0);case 12:case"end":return e.stop()}}),e,null,[[0,9]])})))()},fetchChatroom:function(){var e=this;return Object(m["a"])(regeneratorRuntime.mark((function t(){var r,s,a,n,c;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return r=e.$loading.show({isFullPage:!0,opacity:1},{default:e.$createElement("MyLoading")}),t.prev=1,t.next=4,p["a"].getChatRoom();case 4:s=t.sent,a=s.data,e.messages=a.histroy.filter((function(e){return"0"===e.targetChannel})),e.messages.filter((function(e){return"userComein"===e.type})).forEach((function(t){e.userComeinObject[t.message]=t.createdAt})),n=[],e.messages.forEach((function(t){"userComein"===t.type&&t.createdAt<e.userComeinObject[t.message]&&n.push(t.id)})),e.messages=e.messages.filter((function(e){return!1===n.includes(e.id)})),c=e.$refs.boardWrapper,c&&(c.scrollTop=c.scrollHeight,c.animate({scrollTop:c.scrollHeight})),r.hide(),t.next=21;break;case 16:t.prev=16,t.t0=t["catch"](1),r.hide(),console.log(t.t0),h["a"].fire({icon:"error",title:"目前無法連線聊天室，請稍候"});case 21:case"end":return t.stop()}}),t,null,[[1,16]])})))()}}},g=v,b=(r("0796"),r("2877")),C=Object(b["a"])(g,d,f,!1,null,null,null),U=C.exports,y={components:{MessengeBoard:U},data:function(){return{onlineNumber:0,onlineUsers:[]}},mounted:function(){this.onlineUsers=[this.currentUser]},computed:Object(n["a"])({},Object(i["b"])(["currentUser","isAuthenticated"])),watch:{onlineUsers:function(){return this.onlineUsers}},methods:{updateOnelineUsers:function(e){if(this.onlineUsers=e,!this.onlineUsers.map((function(e){return e.User.id})).includes(this.currentUser.id)){var t=Object(n["a"])(Object(n["a"])({},this.currentUser),{},{User:{name:this.currentUser.name,account:this.currentUser.account,avatar:this.currentUser.avatar}});this.onlineUsers=[].concat(Object(l["a"])(this.onlineUsers),[t])}}}},w=y,_=(r("86fa"),Object(b["a"])(w,o,u,!1,null,null,null)),O=_.exports,x={components:{Navbar:c["a"],Chatroom:O},computed:Object(n["a"])({},Object(i["b"])(["currentUser","isAuthenticated"]))},j=x,A=(r("9c66"),Object(b["a"])(j,s,a,!1,null,null,null));t["default"]=A.exports},"44e7":function(e,t,r){var s=r("861d"),a=r("c6b6"),n=r("b622"),c=n("match");e.exports=function(e){var t;return s(e)&&(void 0!==(t=e[c])?!!t:"RegExp"==a(e))}},"498a":function(e,t,r){"use strict";var s=r("23e7"),a=r("58a8").trim,n=r("c8d2");s({target:"String",proto:!0,forced:n("trim")},{trim:function(){return a(this)}})},5899:function(e,t){e.exports="\t\n\v\f\r                　\u2028\u2029\ufeff"},"58a8":function(e,t,r){var s=r("1d80"),a=r("5899"),n="["+a+"]",c=RegExp("^"+n+n+"*"),i=RegExp(n+n+"*$"),o=function(e){return function(t){var r=String(s(t));return 1&e&&(r=r.replace(c,"")),2&e&&(r=r.replace(i,"")),r}};e.exports={start:o(1),end:o(2),trim:o(3)}},"5a34":function(e,t,r){var s=r("44e7");e.exports=function(e){if(s(e))throw TypeError("The method doesn't accept regular expressions");return e}},"71af":function(e,t,r){},8264:function(e,t,r){},"83bc":function(e,t,r){},"86fa":function(e,t,r){"use strict";r("71af")},"99af":function(e,t,r){"use strict";var s=r("23e7"),a=r("d039"),n=r("e8b5"),c=r("861d"),i=r("7b0b"),o=r("50c4"),u=r("8418"),l=r("65f0"),d=r("1dde"),f=r("b622"),m=r("2d00"),h=f("isConcatSpreadable"),p=9007199254740991,v="Maximum allowed index exceeded",g=m>=51||!a((function(){var e=[];return e[h]=!1,e.concat()[0]!==e})),b=d("concat"),C=function(e){if(!c(e))return!1;var t=e[h];return void 0!==t?!!t:n(e)},U=!g||!b;s({target:"Array",proto:!0,forced:U},{concat:function(e){var t,r,s,a,n,c=i(this),d=l(c,0),f=0;for(t=-1,s=arguments.length;t<s;t++)if(n=-1===t?c:arguments[t],C(n)){if(a=o(n.length),f+a>p)throw TypeError(v);for(r=0;r<a;r++,f++)r in n&&u(d,f,n[r])}else{if(f>=p)throw TypeError(v);u(d,f++,n)}return d.length=f,d}})},"9c66":function(e,t,r){"use strict";r("8264")},ab13:function(e,t,r){var s=r("b622"),a=s("match");e.exports=function(e){var t=/./;try{"/./"[e](t)}catch(r){try{return t[a]=!1,"/./"[e](t)}catch(s){}}return!1}},c8d2:function(e,t,r){var s=r("d039"),a=r("5899"),n="​᠎";e.exports=function(e){return s((function(){return!!a[e]()||n[e]()!=n||a[e].name!==e}))}},caad:function(e,t,r){"use strict";var s=r("23e7"),a=r("4d64").includes,n=r("44d2"),c=r("ae40"),i=c("indexOf",{ACCESSORS:!0,1:0});s({target:"Array",proto:!0,forced:!i},{includes:function(e){return a(this,e,arguments.length>1?arguments[1]:void 0)}}),n("includes")},d81d:function(e,t,r){"use strict";var s=r("23e7"),a=r("b727").map,n=r("1dde"),c=r("ae40"),i=n("map"),o=c("map");s({target:"Array",proto:!0,forced:!i||!o},{map:function(e){return a(this,e,arguments.length>1?arguments[1]:void 0)}})}}]);
//# sourceMappingURL=chunk-476cacfe.5eaef6db.js.map